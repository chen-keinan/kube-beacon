{
  "benchmark_type": "k8s",
  "categories": [
    {
      "name": "Control Plane Components",
      "sub_category": {
        "name": "Worker Nodes",
        "audit_tests": [
          {
            "name": "4.1.1 Ensure that the kubelet service file permissions are set to 644 or more restrictive",
            "description": "Ensure that the kubelet service file has permissions of 644 or more restrictive.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "stat -c %a /etc/systemd/system/kubelet.service.d/10-kubeadm.conf"
            ],
            "remediation": "Run the below command (based on the file location on your system) on the each worker node. For example,\nchmod 755 /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "$0 <= 644;",
            "default_value": "By default, the kubelet service file has permissions of 640.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/",
              "https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#44-joining-your-nodes",
              "https://kubernetes.io/docs/admin/kubeadm/#kubelet-drop-in"
            ]
          },
          {
            "name": "4.1.2 Ensure that the kubelet service file ownership is set to root:root",
            "description": "Ensure that the kubelet service file ownership is set to root:root.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "stat -c %U:%G /etc/systemd/system/kubelet.service.d/10-kubeadm.conf"
            ],
            "remediation": "Run the below command (based on the file location on your system) on the each worker node. For example,\nchown root:root /etc/systemd/system/kubelet.service.d/10-kubeadm.conf",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "'$0' == 'root:root';",
            "default_value": "By default, kubelet service file ownership is set to root:root.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/",
              "https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#44-joining-your-nodes",
              "https://kubernetes.io/docs/admin/kubeadm/#kubelet-drop-in"
            ]
          },
          {
            "name": "4.1.3 If proxy kubeconfig file exists ensure permissions are set to 644 or more restrictive",
            "description": "If kube-proxy is running, and if it is using a file-based kubeconfig file, ensure that the proxy kubeconfig file has permissions of 644 or more restrictive.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kube-proxy |grep 'kubeconfig' | grep -o 'kubeconfig=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "stat -c %a #0"
            ],
            "remediation": "Run the below command (based on the file location on your system) on the each worker node. For example,\nchmod 644 <proxy kubeconfig file>",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "$1 <= 644;",
            "default_value": "By default, proxy file has permissions of 640.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-proxy/"
            ]
          },
          {
            "name": "4.1.4 If proxy kubeconfig file exists ensure ownership is set to root:root",
            "description": "If kube-proxy is running, ensure that the file ownership of its kubeconfig file is set to root:root.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kube-proxy |grep 'kubeconfig' | grep -o 'kubeconfig=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "stat -c %U:%G #0"
            ],
            "remediation": "Run the below command (based on the file location on your system) on the each worker node. For example,\nchown root:root <proxy kubeconfig file>",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "'$1' == 'root:root';",
            "default_value": "By default, proxy file ownership is set to root:root.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-proxy/"
            ]
          },
          {
            "name": "4.1.5 Ensure that the --kubeconfig kubelet.conf file permissions are set to 644 or more restrictive",
            "description": "Ensure that the kubelet.conf file has permissions of 644 or more restrictive.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "stat -c %a /etc/systemd/system/kubelet.service.d/10-kubeadm.conf"
            ],
            "remediation": "Remediation:\nRun the below command (based on the file location on your system) on the each worker node. For example,\nchmod 644 /etc/kubernetes/kubelet.conf",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "$0 <= 644;",
            "default_value": "By default, kubelet.conf file has permissions of 640.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/"
            ]
          },
          {
            "name": "4.1.6 Ensure that the --kubeconfig kubelet.conf file ownership is set to root:root",
            "description": "Ensure that the kubelet.conf file ownership is set to root:root.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "stat -c %U:%G /etc/systemd/system/kubelet.service.d/10-kubeadm.conf"
            ],
            "remediation": "Run the below command (based on the file location on your system) on the each worker node. For example,\nchown root:root /etc/kubernetes/kubelet.conf",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "'$0' == 'root:root';",
            "default_value": "By default, kubelet.conf file ownership is set to root:root.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/"
            ]
          },
          {
            "name": "4.1.7 Ensure that the certificate authorities file permissions are set to 644 or more restrictive",
            "description": "Ensure that the certificate authorities file has permissions of 644 or more restrictive.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kubelet |grep 'client-ca-file' | grep -o 'client-ca-file=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "stat -c %a #0"
            ],
            "remediation": "Run the following command to modify the file permissions of the --client-ca-file chmod 644 <filename>",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "$1 <= 644;",
            "default_value": "By default no --client-ca-file is specified.",
            "references": [
              "https://kubernetes.io/docs/admin/authentication/#x509-client-certs"
            ]
          },
          {
            "name": "4.1.8 Ensure that the client certificate authorities file ownership is set to root:root",
            "description": "Ensure that the certificate authorities file ownership is set to root:root.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kubelet |grep 'client-ca-file' | grep -o 'client-ca-file=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "sudo stat -c %U:%G #0"
            ],
            "remediation": "Remediation:\nRun the following command to modify the ownership of the --client-ca-file. chown root:root <filename>",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "'$1' <= 'root:root';",
            "default_value": "By default no --client-ca-file is specified.",
            "references": [
              "https://kubernetes.io/docs/admin/authentication/#x509-client-certs"
            ]
          },
          {
            "name": "4.1.9 Ensure that the kubelet --config configuration file has permissions set to 644 or more restrictive ",
            "description": "Ensure that if the kubelet refers to a configuration file with the --config argument, that file has permissions of 644 or more restrictive.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "sudo stat -c %a /var/lib/kubelet/config.yaml"
            ],
            "remediation": "Remediation:\nRun the following command (using the config file location identied in the Audit step)\nchmod 644 /var/lib/kubelet/config.yaml",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "$0 <= 644;",
            "default_value": "By default, the /var/lib/kubelet/config.yaml file as set up by kubeadm has permissions of 644.",
            "references": [
              "https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/"
            ]
          },
          {
            "name": "4.1.10 Ensure that the kubelet --config configuration file ownership is set to root:root",
            "description": "Ensure that if the kubelet refers to a configuration file with the --config argument, that file is owned by root:root.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "sudo stat -c %U:%G /var/lib/kubelet/config.yaml"
            ],
            "remediation": "Run the following command (using the config file location identied in the Audit step)\nchown root:root /etc/kubernetes/kubelet.conf",
            "check_type": "multi_param",
            "impact": "None",
            "eval_expr": "'$1' <= 'root:root';",
            "default_value": "By default, /var/lib/kubelet/config.yaml file as set up by kubeadm is owned by root:root.",
            "references": [
              "https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/"
            ]
          },
          {
            "name": "4.2.1 Ensure that the --anonymous-auth argument is set to false",
            "description": "Disable anonymous requests to the Kubelet server.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kubelet |grep ' --config' | grep -o ' --config=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "sudo grep -A5 'authentication' #0 | grep -A1 'anonymous'| grep  -o 'enabled:[^\"]\\S*'| awk -F \":\" '{print $2}' |awk 'FNR <= 1'",
              "ps -ef | grep kubelet |grep ' --anonymous-auth' | grep -o ' --anonymous-auth=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'"
            ],
            "remediation": "Run the following command (using the config file location identied in the Audit step)\nchown root:root /etc/kubernetes/kubelet.conf",
            "check_type": "multi_param",
            "impact": "Anonymous requests will be rejected.",
            "eval_expr": "'$1' == 'false'; || '$2' == 'false';",
            "default_value": "By default, anonymous access is enabled.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/",
              "https://kubernetes.io/docs/admin/kubelet-authentication-authorization/#kubelet-authentication"
            ]
          },
          {
            "name": "4.2.2 Ensure that the --authorization-mode argument is not set to AlwaysAllow",
            "description": "Do not allow all requests. Enable explicit authorization.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kubelet |grep ' --config' | grep -o ' --config=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "sudo grep -A5 'authorization' #0 | grep  'mode:[^\"]\\S*'| awk -F \":\" '{print $2}' |awk 'FNR <= 1'",
              "ps -ef | grep kubelet |grep ' --authorization-mode' | grep -o ' --authorization-mode=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'"
            ],
            "remediation": "If using a Kubelet config file, edit the file to set authorization: mode to Webhook.\nIf using executable arguments, edit the kubelet service file /etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and set the below parameter in KUBELET_AUTHZ_ARGS variable.\n--authorization-mode=Webhook",
            "check_type": "multi_param",
            "impact": "Unauthorized requests will be denied.",
            "eval_expr": "'$1' != 'AlwaysAllow'; && '$2' != 'AlwaysAllow';",
            "default_value": "By default, --authorization-mode argument is set to AlwaysAllow.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/",
              "https://kubernetes.io/docs/admin/kubelet-authentication-authorization/#kubelet-authentication"
            ]
          },
          {
            "name": "4.2.3 Ensure that the --client-ca-file argument is set as appropriate",
            "description": "Enable Kubelet authentication using certificates.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kubelet |grep ' --config' | grep -o ' --config=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "sudo grep -A10 'authentication' #0 |grep -A1 'x509' |grep 'clientCAFile:[^\"]\\S*'| awk -F \":\" '{print $2}' |awk 'FNR <= 1'",
              "ps -ef | grep kubelet |grep ' --client-ca-file' | grep -o ' --client-ca-file=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'"
            ],
            "remediation": "If using a Kubelet config file, edit the file to set authentication: x509: clientCAFile to the location of the client CA file.\nIf using command line arguments, edit the kubelet service file /etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and set the below parameter in KUBELET_AUTHZ_ARGS variable.\n--client-ca-file=<path/to/client-ca-file>",
            "check_type": "multi_param",
            "impact": "You require TLS to be configured on apiserver as well as kubelets.",
            "eval_expr": "'$1' != ''; || '$2' != '';",
            "default_value": "By default, --client-ca-file argument is not set.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/",
              "https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/,"
            ]
          },
          {
            "name": "4.2.4 Verify that the --read-only-port argument is set to 0",
            "description": "Disable the read-only port.",
            "profile_applicability": "Level 1 - Worker Node",
            "audit": [
              "ps -ef | grep kubelet |grep ' --read-only-port' | grep -o ' --read-only-port=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
              "sudo grep 'readOnlyPort' #0 |grep 'readOnlyPort:[^\"]\\S*'| awk -F \":\" '{print $2}' |awk 'FNR <= 1'"
            ],
            "remediation": "If using a Kubelet config file, edit the file to set readOnlyPort to 0.\nIf using command line arguments, edit the kubelet service file /etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.\n--read-only-port=0",
            "check_type": "multi_param",
            "impact": "Removal of the read-only port will require that any service which made use of it will need to be re-configured to use the main Kubelet API.",
            "eval_expr": "'$0' 0= ''; || '$1' == '0';",
            "default_value": "By default, --read-only-port is set to 10255/TCP. However, if a config file is specified by -- config the default value for readOnlyPort is 0.",
            "references": [
              "https://kubernetes.io/docs/admin/kubelet/"
            ]
          }
        ]
      }
    }
  ]
}